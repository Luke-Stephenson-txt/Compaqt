<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compaqt - Prompt Packing Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Compaqt</h1>
            <p class="tagline">Post-retrieval prompt packing for LLM coding agents</p>
        </div>
    </header>

    <main>
        <div class="controls">
            <div class="control-group">
                <label for="token-budget">Token Budget</label>
                <input type="range" id="token-budget" min="500" max="10000" value="4000" step="100">
                <span id="budget-display">4000</span>
            </div>
            <button id="pack-btn" class="btn-primary">Pack Context</button>
            <button id="download-btn" class="btn-secondary" disabled>Download Packed Prompt</button>
        </div>

        <div class="columns">
            <!-- Column 1: Retrieved Files -->
            <div class="column">
                <div class="column-header">
                    <h2>Retrieved Files</h2>
                    <span class="token-badge">Total: <span id="total-tokens">{{ total_tokens }}</span> tokens</span>
                </div>
                <div class="files-list" id="files-list">
                    {% for file in files %}
                    <div class="file-card">
                        <div class="file-header">
                            <span class="file-name">{{ file.name }}</span>
                            <span class="file-tokens">{{ file.tokens }} tokens</span>
                        </div>
                        <pre class="file-content"><code>{{ file.content }}</code></pre>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Column 2: Packed Context -->
            <div class="column">
                <div class="column-header">
                    <h2>Packed Context</h2>
                    <span class="token-badge" id="packed-badge">Packed: -- tokens</span>
                </div>
                <div id="packed-content" class="packed-area">
                    <div class="placeholder">
                        <p>Click "Pack Context" to minimize and pack files into your token budget.</p>
                    </div>
                </div>
                <div id="stats-panel" class="stats-panel hidden">
                    <h3>Token Savings Report</h3>
                    <div class="stats-grid">
                        <div class="stat">
                            <span class="stat-label">Original</span>
                            <span class="stat-value" id="stat-original">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Packed</span>
                            <span class="stat-value" id="stat-packed">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Saved</span>
                            <span class="stat-value" id="stat-saved">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Reduction</span>
                            <span class="stat-value" id="stat-percent">--%</span>
                        </div>
                    </div>
                    <div class="files-summary">
                        <div class="included">
                            <h4>Included (<span id="included-count">0</span>)</h4>
                            <ul id="included-list"></ul>
                        </div>
                        <div class="excluded">
                            <h4>Excluded (<span id="excluded-count">0</span>)</h4>
                            <ul id="excluded-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 3: LLM Output -->
            <div class="column">
                <div class="column-header">
                    <h2>LLM Output</h2>
                    <span class="token-badge">Simulated</span>
                </div>
                <div class="llm-output">
                    <div class="output-section">
                        <h3>Baseline (Without Packing)</h3>
                        <div class="output-box baseline">
                            <p>With the full context of {{ total_tokens }} tokens, the LLM would process all retrieved files including comments, docstrings, and formatting.</p>
                            <p class="output-note">Higher token usage = higher cost + slower response</p>
                        </div>
                    </div>
                    <div class="output-section">
                        <h3>With Compaqt Packing</h3>
                        <div class="output-box packed" id="llm-packed-output">
                            <p>Run packing to see the optimized context...</p>
                        </div>
                    </div>
                    <div class="comparison-note" id="comparison-note" style="display: none;">
                        <strong>Result:</strong> Same code understanding with <span id="token-savings">--</span> fewer tokens!
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Compaqt Demo - Prompt packing for efficient LLM coding assistance</p>
    </footer>

    <script>
        let packedText = '';

        const budgetSlider = document.getElementById('token-budget');
        const budgetDisplay = document.getElementById('budget-display');
        const packBtn = document.getElementById('pack-btn');
        const downloadBtn = document.getElementById('download-btn');

        budgetSlider.addEventListener('input', () => {
            budgetDisplay.textContent = budgetSlider.value;
        });

        packBtn.addEventListener('click', async () => {
            packBtn.disabled = true;
            packBtn.textContent = 'Packing...';

            try {
                const response = await fetch('/pack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token_budget: parseInt(budgetSlider.value) })
                });

                const result = await response.json();
                packedText = result.packed_text;

                // Update packed content
                const packedContent = document.getElementById('packed-content');
                packedContent.innerHTML = `<pre class="packed-code"><code>${escapeHtml(result.packed_text)}</code></pre>`;

                // Update badge
                document.getElementById('packed-badge').textContent = `Packed: ${result.stats.packed_tokens} tokens`;

                // Update stats
                const statsPanel = document.getElementById('stats-panel');
                statsPanel.classList.remove('hidden');

                document.getElementById('stat-original').textContent = result.stats.original_total_tokens;
                document.getElementById('stat-packed').textContent = result.stats.packed_tokens;
                document.getElementById('stat-saved').textContent = result.stats.tokens_saved;
                document.getElementById('stat-percent').textContent = result.stats.savings_percentage + '%';

                // Update included files
                document.getElementById('included-count').textContent = result.included_files.length;
                const includedList = document.getElementById('included-list');
                includedList.innerHTML = result.included_files.map(f => 
                    `<li>${f.name} <span class="savings">(${f.original_tokens} â†’ ${f.packed_tokens})</span></li>`
                ).join('');

                // Update excluded files
                document.getElementById('excluded-count').textContent = result.excluded_files.length;
                const excludedList = document.getElementById('excluded-list');
                excludedList.innerHTML = result.excluded_files.map(f => 
                    `<li>${f.name} <span class="reason">(${f.reason})</span></li>`
                ).join('');

                // Update LLM output simulation
                const llmOutput = document.getElementById('llm-packed-output');
                llmOutput.innerHTML = `
                    <p>With Compaqt, the LLM receives a minimized context of <strong>${result.stats.packed_tokens}</strong> tokens.</p>
                    <p>Comments, docstrings, and blank lines removed while preserving all code functionality.</p>
                    <p class="output-note">Lower token usage = lower cost + faster response</p>
                `;

                // Show comparison
                const comparisonNote = document.getElementById('comparison-note');
                comparisonNote.style.display = 'block';
                document.getElementById('token-savings').textContent = result.stats.tokens_saved;

                // Enable download
                downloadBtn.disabled = false;

            } catch (error) {
                console.error('Packing failed:', error);
                alert('Failed to pack context. Please try again.');
            } finally {
                packBtn.disabled = false;
                packBtn.textContent = 'Pack Context';
            }
        });

        downloadBtn.addEventListener('click', async () => {
            if (!packedText) return;

            const blob = new Blob([packedText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'packed_prompt.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
